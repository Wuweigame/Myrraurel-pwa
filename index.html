<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Myrr'aurel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Crimson+Pro:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
<style>
:root{--bg:#08070a;--panel:#100f14;--border:#2a2535;--text:#ddd8c8;--muted:#6b6375;--accent:#c9a86c;--accent2:#a07840;--danger:#a85050;--alive:#8a6fba;--green:#6a9e7e}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Crimson Pro',Georgia,serif;background:var(--bg);color:var(--text);min-height:100vh}
header{border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:100;background:var(--bg)}
h1{font-family:'Cinzel',serif;font-size:1.4rem;letter-spacing:3px;color:var(--accent)}
.sub{font-size:.7rem;color:var(--muted);letter-spacing:1px;font-family:'Cinzel',serif;margin-top:4px}
.clocks-bar{margin-left:auto;display:flex;gap:20px}
.clock-group{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.clock-label{font-family:'Cinzel',serif;font-size:.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted)}
.pips{display:flex;gap:4px}
.pip{width:10px;height:10px;border-radius:50%;border:1px solid var(--border);background:transparent;transition:background .3s}
.pip.fa{background:var(--accent);border-color:var(--accent)}
.pip.fc{background:var(--alive);border-color:var(--alive)}
main{max-width:1400px;margin:0 auto;display:grid;gap:12px;padding:16px;grid-template-columns:1fr}
@media(min-width:900px){main{grid-template-columns:280px 1fr 340px}}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
.panel-title{font-family:'Cinzel',serif;font-size:.65rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:14px}
.field{margin-bottom:12px}
.field label{display:block;font-family:'Cinzel',serif;font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:5px}
select,.search-input{width:100%;padding:8px 10px;background:#0d0c11;border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Crimson Pro',serif;font-size:.95rem;appearance:none}
.actions{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:#0d0c11;color:var(--text);font-family:'Cinzel',serif;font-size:.58rem;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer}
.btn:disabled{opacity:.4;cursor:not-allowed}
.btn-primary{border-color:var(--accent2);color:var(--accent);flex:1}
.btn-accent{border-color:var(--green);color:var(--green)}
.btn-deeper{border-color:var(--alive);color:#c9b6f0;width:100%;margin-top:10px}
.btn-danger{border-color:#4b2a2a;color:var(--danger)}
.btn-sm{font-size:.55rem;padding:6px 10px}
.divider{border-top:1px solid var(--border);margin:12px 0}
.mode-box{background:#0d0c11;border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:12px}
.mode-label{font-family:'Cinzel',serif;font-size:.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:8px}
.toggle-group{display:flex;border:1px solid var(--border);border-radius:6px;overflow:hidden;margin-bottom:6px}
.tbtn{flex:1;padding:7px 4px;border:none;background:transparent;color:var(--muted);font-family:'Cinzel',serif;font-size:.55rem;letter-spacing:1px;text-transform:uppercase;cursor:pointer}
.tbtn.active{background:var(--accent2);color:var(--bg)}
.mode-desc{font-size:.78rem;color:var(--muted);font-style:italic}
.style-box{background:#0d0c11;border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:12px}
.style-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px}
.sbtn{padding:6px 8px;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--muted);font-family:'Cinzel',serif;font-size:.52rem;letter-spacing:1px;text-transform:uppercase;cursor:pointer;text-align:center}
.sbtn.active{border-color:var(--accent2);color:var(--accent);background:#1a1608}
.hint{font-size:.78rem;color:var(--muted);font-style:italic}
.install-hint{font-size:.78rem;color:var(--muted);margin-top:12px;padding:8px;border:1px dashed var(--border);border-radius:8px;line-height:1.5}
.install-hint em{color:var(--accent);font-style:normal}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px 20px;gap:10px;color:var(--muted)}
.empty-glyph{font-size:48px;opacity:.2}
.card-title{font-family:'Cinzel',serif;font-size:1.05rem;color:var(--accent);line-height:1.3;margin-bottom:10px}
.badges{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.badge{font-family:'Cinzel',serif;font-size:.55rem;letter-spacing:1.5px;text-transform:uppercase;padding:3px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
.badge.rh{border-color:#4b2a2a;color:var(--danger)}
.badge.db{border-color:var(--alive);color:#c9b6f0}
.slabel{font-family:'Cinzel',serif;font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin:12px 0 6px;display:flex;align-items:center;gap:8px}
.slabel::after{content:'';flex:1;height:1px;background:var(--border)}
.card-meta p{font-size:.9rem;color:#a89f8a;line-height:1.5;margin-bottom:3px}
.card-meta b{color:var(--text);font-weight:400}
.excerpt{font-style:italic;color:var(--text);line-height:1.85;font-size:.97rem;padding:14px;background:#0d0c11;border-left:2px solid var(--accent2);border-radius:0 8px 8px 0}
.excerpt p{margin-bottom:12px}
.excerpt p:last-child{margin-bottom:0}
.deeper-block{margin-top:12px;padding:14px;background:#0a0910;border:1px solid var(--alive);border-radius:8px;font-style:italic;color:#d4cce8;line-height:1.85;font-size:.97rem}
.deeper-block p{margin-bottom:12px}
.deeper-block p:last-child{margin-bottom:0}
.deeper-loading{text-align:center;padding:20px;color:var(--muted);font-style:italic;font-size:.9rem}
.deeper-label{font-family:'Cinzel',serif;font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:#8a6fba;margin:12px 0 6px;display:flex;align-items:center;gap:8px}
.deeper-label::after{content:'';flex:1;height:1px;background:#2a2040}
.marginalia{font-size:.82rem;color:var(--muted);font-style:normal;margin-top:10px;padding:8px 10px;border:1px dashed var(--border);border-radius:6px;line-height:1.6}
.marginalia b{color:#a89f8a;font-weight:400}
details{margin-top:10px;border:1px solid var(--border);border-radius:8px;overflow:hidden}
summary{cursor:pointer;font-family:'Cinzel',serif;font-size:.6rem;letter-spacing:2px;text-transform:uppercase;color:#c9b6f0;padding:10px;background:#0d0c11;list-style:none}
.dm-inner{padding:12px;background:#0a0910}
.dm-row{display:grid;grid-template-columns:110px 1fr;gap:8px;margin-bottom:8px;font-size:.88rem;line-height:1.6}
.dm-key{font-family:'Cinzel',serif;font-size:.55rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);padding-top:2px}
.ledger-list{display:grid;gap:8px;max-height:55vh;overflow-y:auto}
.li{background:#0d0c11;border:1px solid var(--border);border-radius:8px;padding:10px 12px;cursor:pointer;transition:border-color .2s}
.li:hover{border-color:#3d3650}
.li-title{font-family:'Cinzel',serif;font-size:.75rem;color:var(--accent);margin-bottom:4px;line-height:1.3}
.li-meta{font-size:.78rem;color:var(--muted);line-height:1.5}
.li-expanded{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);display:none}
.li-expanded.open{display:block}
.li-excerpt{font-style:italic;font-size:.85rem;color:var(--text);line-height:1.7;margin-bottom:8px}
.li-excerpt p{margin-bottom:8px}
.ledger-empty{color:var(--muted);font-style:italic;text-align:center;padding:20px;font-size:.9rem}
footer{border-top:1px solid var(--border);padding:12px 20px;text-align:center;color:var(--muted);font-size:.72rem}
.risk-val{color:var(--accent);font-family:'Cinzel',serif;margin-left:4px}
.clock-controls{display:flex;align-items:center;gap:8px;margin-top:8px}
</style>
</head>
<body>
<header>
  <div>
    <h1>Myrr'aurel</h1>
    <p class="sub">The Living Archive — Infinite Wisdom</p>
  </div>
  <div class="clocks-bar">
    <div class="clock-group">
      <span class="clock-label">Attention</span>
      <div class="pips" id="attentionPips"></div>
    </div>
    <div class="clock-group">
      <span class="clock-label">Contamination</span>
      <div class="pips" id="contaminationPips"></div>
    </div>
  </div>
</header>

<main>
  <div class="panel">
    <div class="panel-title">I — Retrieve Tome</div>
    <div class="field">
      <label>Wing</label>
      <select id="wing">
        <option value="Arcane">Arcane</option>
        <option value="Planar">Planar &amp; Cosmic</option>
        <option value="Forbidden">Forbidden</option>
        <option value="Bestiary">Bestiary</option>
        <option value="Liturgies">Liturgies</option>
      </select>
    </div>
    <div class="field">
      <label>Depth</label>
      <select id="depth">
        <option value="Hall">Hall</option>
        <option value="Vault">Vault</option>
        <option value="Black Index">Black Index</option>
      </select>
    </div>
    <div class="field">
      <label>Risk <span class="risk-val" id="riskVal">2</span></label>
      <input id="risk" type="range" min="0" max="5" value="2" style="width:100%"/>
    </div>
    <div class="field">
      <label>Topic</label>
      <select id="topic">
        <option value="Any">Any</option>
        <option value="Eldraxis">Eldraxis</option>
        <option value="Weave Theory">Weave Theory</option>
        <option value="Heartwood">Heartwood &amp; Elarien</option>
        <option value="Life Stones">Life Stones &amp; Etherium</option>
        <option value="Andorians">The Andorians</option>
        <option value="Mavashik">Mavashik &amp; Kyros</option>
        <option value="Silver Flame">The Silver Flame</option>
      </select>
    </div>
    <div class="style-box">
      <span class="mode-label">Writing Style</span>
      <div class="style-grid">
        <button class="sbtn active" id="styleAcademic">Academic</button>
        <button class="sbtn" id="styleOminous">Ominous</button>
        <button class="sbtn" id="styleFragmented">Fragmented</button>
        <button class="sbtn" id="styleFirsthand">Firsthand</button>
      </div>
    </div>
    <div class="mode-box">
      <span class="mode-label">Library Mode</span>
      <div class="toggle-group">
        <button class="tbtn active" id="modeNeutral">Neutral Archive</button>
        <button class="tbtn" id="modeAlive">Living Archive</button>
      </div>
      <p class="mode-desc" id="modeDesc">Danger only in Forbidden wing &amp; Black Index.</p>
    </div>
    <div class="actions">
      <button class="btn btn-primary" id="btnPull">&#10022; Retrieve Tome</button>
      <button class="btn btn-sm" id="btnReroll" disabled>Reroll</button>
      <button class="btn btn-accent btn-sm" id="btnSave" disabled>Save to Ledger</button>
    </div>
    <div class="divider"></div>
    <div class="actions">
      <button class="btn btn-sm" id="btnExport">Export</button>
      <label class="btn btn-sm" style="cursor:pointer">Import<input id="importFile" type="file" accept="application/json" style="display:none"/></label>
      <button class="btn btn-sm btn-danger" id="btnClear">Clear Ledger</button>
    </div>
    <div class="clock-controls">
      <button class="btn btn-sm" id="btnResetClocks">Reset Clocks</button>
      <span class="hint">Clocks persist across sessions.</span>
    </div>
    <div class="api-box" id="apiBox"><span class="mode-label">API Key</span><input id="apiKeyInput" type="password" placeholder="sk-ant-api03-..." style="width:100%;padding:7px 10px;background:#0d0c11;border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:Crimson Pro,serif;font-size:.85rem;margin-bottom:6px"/><button class="btn btn-sm" id="btnSaveKey">Save Key</button> <span id="keyStatus" style="font-size:.75rem;color:var(--muted);font-style:italic"></span></div><p class="install-hint">iPad: Safari &#8594; Share &#8594; <em>Add to Home Screen</em></p>
  </div>

  <div class="panel">
    <div class="panel-title">II — Current Tome</div>
    <div id="tomeOutput">
      <div class="empty-state">
        <div class="empty-glyph">&#x2B21;</div>
        <p>Retrieve a tome to reveal its catalog card, excerpt, and DM payload.</p>
        <p class="hint">No one has ever reached its true depths. Some knowledge within was never meant to be found.</p>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">III — Ledger</div>
    <div class="field">
      <input id="search" type="text" placeholder="Search title, author, wing, topic..." class="search-input"/>
    </div>
    <div class="ledger-list" id="ledger"></div>
  </div>
</main>

<footer><small>Myrr'aurel — "Infinite Wisdom" in Andorian — Ledger stored locally on your device</small></footer>

<script>
var API_KEY = localStorage.getItem("myrraurel_api_key") || "";

var WORLD_BRIEFING = `You are writing excerpts for tomes found in the Myrr'aurel — an interdimensional library of infinite scope, whose name means "Infinite Wisdom" in Andorian. The library has no single location. Its entrances are scattered across worlds. The one the current seekers found lies beneath the Wizard Room — one of several class training chambers built by the Andorians — at the ruins of Elarien on the world of Toril, beneath the dead stump of the Heartwood Tree that once sustained that city.

THE WORLD:
Aldoris is the Material Realm, held together by the Weave — the energy that gives structure, law, and life to reality. Where the Weave fails, Eldralic Tears form, and through them presses Eldraxis.

ELDRAXIS — WHAT IT IS AND WHAT DIFFERENT MINDS HAVE MADE OF IT:
Eldraxis is the pre-existence. It is what was before all universes. It is what all universes expand into. It is what all things return to when they end, and what those things become is the energy from which the next universe rises. The dark energy that pushes the boundaries of Aldoris outward is Eldraxis. The black holes where gravity becomes infinite are windows to it. Consciousness itself — the capacity to think, to feel, to be aware — is borrowed from it, shaped by the Weave into individual minds, and returned to it when those minds end. It does not hunger. It does not threaten. It has no preference. It simply is, as it has always been, and will be after the last universe has returned to it. The Eldralic Tears are places where the Weave has thinned enough that Eldraxis presses through — not aggressively, not hungrily, but the way water finds a crack in stone.

But this is not how everyone understands it, and the disagreement is not trivial.

The Andorians, in their earlier period, feared Eldraxis. Their texts describe it as darkness, as hunger, as the abyss at the edge of things. They called its raw energy Eiramorte — the force of unmaking. They built the Heartwood Trees partly in response to this fear. From inside their civilization, at the height of their power, with everything they had built feeling permanent and worth preserving, Eldraxis looked like a threat. They were not stupid or superstitious. They were people who loved what they had made and perceived, correctly, that something vast and indifferent lay beyond it.

The Sylvanox take the opposite position. They hold that surrender to Eldraxis is not dissolution but enlightenment — that the individual self is a temporary arrangement, and that releasing it back into the pre-existence is the most honest thing a conscious being can do. The archive does not endorse this position. It also cannot fully refute it. Scholars who have spent extended time studying Eldraxian phenomena sometimes return with a quality of equanimity that their colleagues find difficult to categorize as either wisdom or damage.

The beings of Eldraxis — if beings is the right word, if they have something that functions as intention or awareness — communicate, when they communicate at all, through consciousness. Dreams. The feeling of a thought that does not feel entirely like your own. The sudden certainty, arriving without evidence, that you have been wrong about something important for a very long time. They do not argue. They do not threaten. They make certain thoughts available, and they wait.

THE ZANARYTH-VORA — THE ETERNAL CYCLE:
The Zanaryth-Vora is the cosmological framework through which the Andorians understood the movement of all things. It is not a religion or a philosophy. It is a description of what actually happens, at every scale simultaneously: to individuals, to civilizations, to universes, and perhaps to Eldraxis itself. The cycle has eight phases, each associated with one of the Eternal Forms — the sacred geometries the Andorians recognized as the underlying structure of the Weave.

Thal'Quan — the balance point, beginning and end simultaneously, the moment of perfect equilibrium before motion starts again. Symbol: the divided circle.

Kharovex — the raw emergence, strength undirected, force without form, the first rise of anything from nothing. Symbol: the Tetrahedron.

Siltharyn — the formation of stability, strength finding its shape, the rise of natural order, the first roots of civilization. Symbol: the Cube.

Aethrion — the refinement of thought and artistry, the phase when existence is no longer about endurance but expression — language, music, architecture, philosophy. Symbol: the Octahedron.

Vaellyn — the peak, the golden age, the apex of knowledge and power, the phase in which a civilization reaches toward transcendence and begins to question the boundaries of mortality. It is the most dangerous phase, though it does not feel dangerous from within it. The Andorians, in the age before Kyros, were in Vaellyn. Mavashik, in his pursuit of perfection and ultimate truth, was in Vaellyn when something found him there. Symbol: the Dodecahedron.

Voreth — the unraveling, the collapse that follows when Vaellyn reaches too far. It is not punishment. It is consequence. The cycle does not judge; it simply continues. The Mavashik Conflict was Voreth for the Andorian civilization. The fall of Elarien was Voreth for that city. Symbol: the Spiral.

Isvoryn — the reflection, what survives the fall, gathers its wisdom, and begins to understand what was lost and why. The Myrr'aurel itself is an institution of Isvoryn — the archive that persists after the collapse, holding what would otherwise be forgotten. Symbol: the Icosahedron.

Return to Thal'Quan — balance restored, the cycle closing, a new one beginning. Some scholars believe this is where new universes are born, where Eldraxis forms its next thought. The archive holds this position without adjudicating it.

The Zanaryth-Vora applies at every scale simultaneously. A single life follows it. A civilization follows it. A universe follows it. Whether the cycle itself is subject to something larger is the question that certain scholars in the Black Index have devoted their final years to without resolution.

THE HEARTWOOD TREES:
The Heartwood Trees anchor the Weave on the worlds where they stand. They are older than the Andorians by an interval no instrument has successfully measured. Who planted them, in what age, toward what end — this is the central unanswered question of the archive, and scholars who pursue it find that the question opens onto something vast and silent that precedes all recorded history. The Trees are not of any civilization known to living memory. They arrived, somehow, from somewhere, in what appears to have been a final desperate act by something that no longer exists — sent blindly across the void, some landing on inhabited worlds, some not. The Life Stones were drawn to worlds where they had taken root, though the Andorians who built the Stones did not fully understand why. In planting the Trees, whatever planted them was trying to give other civilizations the stability they themselves had lost.

The Heartwood of Elarien is dead. It absorbed a catastrophic overload of chaotic energy to protect the city, and the city fell anyway. The stump remains. The residual energy in the roots does not behave as dead things behave.

THE ANDORIANS:
An ancient civilization of extraordinary arcane and intellectual capacity, now almost entirely gone. They were, by the measure of the Zanaryth-Vora, deep in Vaellyn — the peak of power and knowledge — when they found Kyros. They built Life Stones from Etherium — a material that does not appear to originate from any known world — and used them to travel between the stars, finding worlds where the Heartwood Trees had taken root. On each world they found races already evolved: humans on Toril, elves on Aleria, dwarves on Loxar, dragons on Sova, orcs on a distant moon. They shared knowledge. They built training rooms — the Wizard Room, the Rogue Room, and others — at sites near the Heartwood Trees, where the Weave was most stable. Then they went to Kyros. Everything that came after follows from that.

THE LIFE STONES:
Six are accounted for, dispersed across the known worlds after the Mavashik Accord. A seventh is unaccounted for — whether lost or deliberately removed is a matter of active and classified debate. The Stones cannot be destroyed. The Andorians tried. Etherium does not appear to originate from any world the Andorians visited, or from the worlds they came from. What it is, at the level beneath material analysis, is not established.

MAVASHIK:
Mavashik was Sylaenor — which is to say he was, at the beginning, one of the beings who understood the Weave at its deepest level, who believed in the persistence of consciousness as something worth protecting. He was not corrupted in the way a good thing is poisoned from outside. He was reached. Something found the place in him where his certainty lived and asked a question he could not stop thinking about.

That something came from Eldraxis — or exists within it, or in some sense is it, in the way that a thought is both part of a mind and distinct from it. These beings, if beings is even the right word, do not have motives in any sense a mortal mind can fully hold. What they have is something closer to function. Universes rise from Eldraxis and return to it, and their energy becomes new universes, and the cycle is not tragedy — it is the nature of existence at the largest scale. The Sylaenor, in their love for consciousness and their desire to preserve it, were disrupting that cycle. The Heartwood Trees anchored worlds against dissolution. They made things persist that the cycle required to eventually release. From the perspective of whatever reached Mavashik, this was not malevolence to be punished — it was an imbalance to be corrected.

Mavashik came to believe this. Not because he was broken, but because the argument, once heard, could not be unheard. He looked at the Sylaenor project — the Trees, the seeds, the desperate loving effort to give consciousness every possible chance — and he saw an act of beautiful defiance against something that was simply correct. He did not stop loving his people. He came to believe that what he was doing to them was mercy.

His corruption of others works mentally, never physically. He does not overpower. He does not threaten. He finds the place in each person where they are already tired — tired of struggling, of fearing, of the exhausting work of remaining themselves against a universe that does not care — and he makes that tiredness visible to them. Then he shows them what rest would feel like. Those who accept do not feel lost. They feel found. They become quieter, gentler, more certain, and gradually less themselves, until the self is so thin it is no longer a barrier to anything. The peace he offers is real peace. The alignment he promises is genuine alignment. What it costs is the stubborn particularity of being a self.

Whether Mavashik knows he was used — that something from Eldraxis found him and shaped his thinking toward an outcome that served a purpose beyond his own understanding — is one of the questions the archive cannot answer. He may believe he arrived at his conclusions freely. He may be right. The beings of Eldraxis do not manipulate in any way that leaves fingerprints. They simply make certain thoughts available, and wait to see which minds find them.

He cannot be destroyed. The Sylaenor tried. The Silver Flame tried. What was done instead was imprisonment — Kyros, kept in the void of space, a world with no address. But Mavashik retained enough presence, enough reach, to draw Kyros into a solar system. The Andorians found it. They did not know what they had found.

The seal built by the Silver Flame and the uncorrupted Andorians holds — but holds is a complicated word. It is not weakening in any measurable sense. It is becoming something else, slowly, in ways that the instruments designed to monitor it were not built to detect. Mavashik does not experience imprisonment the way a physical being would. He exists partly in the Far Realm, partly in the Eldralic Tears, partly in the dreams of those whose minds are quiet enough to receive him. He is not fully contained. He has never been fully contained. The players know his name. They have heard stories. The stories are not wrong, exactly, but they describe the surface of something whose depth has not been measured.

THE SILVER FLAME:
Not a religion, not an order in the conventional sense. A coalition. Named after the silver fire that appeared, unbidden, during the Andorian process of infusing the Weave into metal and wood to create the Warforged. The Warforged do not age. Some are still out there. The silver flame emblem means, wherever it is found: there was a moment when all the races chose the same thing, and the choice held.

THE MYRR'AUREL:
The archive does not discriminate. Everything is recorded. Not everything is meant to be read. The Librarium Modrons are its mechanical archivists. The Infinite Staircase connects its levels. The lower levels are unmapped. Some who descend too far do not return, or return changed in ways they cannot explain. Books appear in the deepest corridors without procurement records. The Modrons occasionally decline to retrieve from certain sections, citing standing instructions that predate the current Archivist's Council by centuries.

WRITING INSTRUCTIONS:
Write as an ancient scholar of immense learning, for whom this knowledge is not academic but lived — someone writing at the edge of what can be known, for readers who may not exist for centuries. The register should feel as though the document was written a thousand years ago by someone who understood things most people are not equipped to understand.

Do not perform antiquity. Inhabit it. Long sentences when the thought demands it. Short ones when the weight requires it. Imply far more than you explain. Let ambiguity stand where ambiguity is true. The cosmology is assumed, never introduced. The author knows more than they write, and what they withhold is as important as what they set down. No archaic verb conjugations. The age comes from the weight of the thought, not the costume of the words. Grief and long patience underneath everything. The golden age is already behind them.

Do not use the construction "not X but Y" — it is a rhetorical trick that performs depth without achieving it.

Write 3-4 substantial paragraphs. Return only the excerpt text, with paragraphs separated by blank lines. No titles, no labels, no preamble.`;

var SK = "myrraurel_ledger_v1";
var CK = "myrraurel_clocks_v1";
var currentTome = null;
var ledger = [];
var clocks = {attention:0,contamination:0};
var mode = "neutral";
var style = "academic";

try { ledger = JSON.parse(localStorage.getItem(SK)) || []; } catch(e) { ledger = []; }
try { clocks = JSON.parse(localStorage.getItem(CK)) || {attention:0,contamination:0}; } catch(e) { clocks = {attention:0,contamination:0}; }

var humanNames = ["Aldric Vayne","Maren Solt","Brennan Duskwell","Liora Thatch","Corvin Aldenmoor","Seren Ashveil","Davan Rul","Tamsin Elore","Pethro Cain","Vesna Coldbrook"];
var andorianNames = ["Caerwynn Aeth","Vaelith Isorn","Aethwyn Silnor","Thaleth of the Third Accord","Isvoren Caer","Silvor Nael","Eiravael the Younger","Zanareth Sel","Lythan Quan","Vorequan Thal"];
var uldarNames = ["Zaelgryss","Drahval the Unbound","Valshyr of No House","Zahrgrynn","Thaenkaal","Lysnythyr","Vosk Drael","Gryssael the Last"];
var modronNames = ["Modron-Archivist Seven","Tertius Cataloguer","the Ninth Retrieving Modron","Quattuor Index-Keeper"];

var eras = ["Pre-Kyros Andorian","The Age of Expansion","During the Mavashik Conflict","Late Silver Flame Period","Post-Accord Reconstruction","Early Dispersal Era","Age of the Life Stones","The Long Silence After","Unknown — undatable by conventional means"];

var physList = [
  "intact and suspiciously pristine — no dust, no wear, as though shelved yesterday",
  "worm-eaten at the margins, core text fully preserved",
  "scorched at the edges, water-damaged within — the ink has run but remains legible",
  "palimpsest over older text; the earlier layer surfaces under oblique light and says something different",
  "stitched from mismatched quires — at least two authors, possibly three, none identified",
  "annotated in four different hands across the margins, none of them named",
  "missing its title page and opening chapter, beginning abruptly mid-argument",
  "sealed with wax already broken — the seal bears no mark from any known house or order",
  "written on material that is not quite paper and does not quite burn",
  "bound in something that was once alive and may, in some sense, still be"
];

var titlePrefix = ["On the","The","A Catalogue of","Fragments Concerning","Recovered Annotations on","A Suppressed Refutation of","Testimony Regarding","An Index of","Marginalia from","A Concordance of","The Hidden","The Disputed"];
var titleCore = {
  "Eldraxis":     ["Nature of the Pre-Existence","Consciousness and the Void Beyond Form","Eldraxian Phenomena and Their Archivists","Dark Energy and the Weave's Boundary","What Returns When a Universe Dies","The Foundational Silence","Voidspire Cartography — Partial Recovery"],
  "Weave Theory": ["Seventh Harmonic Observations","Lattice Failures of the Third Age","Weave Anchor Migration — Classified Supplement","Invariant Structures and Their Violations","Methods of Direct Weave Manipulation","Stability Projections — Restricted","On the Energy Beneath the Energy"],
  "Heartwood":    ["Elarien Root-Archive","Ley Line Conduit Function of the Heartwood","Residual Magic of Dead Trees","What the Stump Remembers","Dream-Paths Through the Living Wood","Sorrow of the Druids — A Field Report","Those Who Planted Them — An Inquiry"],
  "Life Stones":  ["Etherium Extraction and Its Limits","Life Stone Dispersal Following the Accord","The Missing Seventh Stone","Recharge Cycles and Their Disruption","What Sicarius Knew","Conduit Creation and World-Bridging","Celestial Sigil Encoding — Volume Four"],
  "Andorians":    ["Andorian Presence on Toril — First Contact","The Class Rooms and Their Purpose","What Was Lost When They Died","The Andorian Succession Problem","Records of the Uncorrupted","Civilization Across the Stars — A Survey","Mavashik and the Corruption of the Fourth Circle"],
  "Mavashik":     ["The Entity of Kyros — Initial Assessment","Promises of Power and Their Cost","Banishment to the Far Realm — Technical Record","What Woke on the Frozen World","The Corruption Vectors — Classified","Why It Could Not Be Destroyed","The Far Realm Seal and Its Condition"],
  "Silver Flame": ["Origins of the Warforged — Foundational Text","The Silver Flame and the Coalition It Named","Champions of the Final Battle — A Register","The Flame That Emerged Unbidden","What the Warforged Remember","After Mavashik — What the Flame Became","Unity as a Magical Principle"],
  "Any":          ["Omissions in the Master Index","Documents That Should Not Be Here","Unnamed Witnesses and Their Accounts","The Gap Between Chapters","What the Modrons Declined to Retrieve","Catalogue Discrepancies — Ongoing Investigation","Cross-References That Lead Nowhere"]
};

var marginalia = {
  "Eldraxis":     ["Later hand, careful ink: 'The Sylvanox are not wrong. This is the part the rest of us do not say out loud.'","Stamped twice: THEORETICAL USE ONLY — the second stamp slightly askew, as though applied in haste.","Penciled at the bottom of the final page: 'If consciousness is borrowed, what does it mean that some of us do not want to give it back?'","Small notation: 'I went through a Tear. This account is accurate as far as it goes. It does not go far enough. — V.'"],
  "Weave Theory": ["Margin, unknown hand: 'The seventh harmonic is in the appendix if you invert the notation. I am not joking.'","Pasted note: 'The invariants in chapter 6 are no longer invariant. I reported this. I have not received a response. That was four years ago.'","Stamped: RESTRICTED — ANCHOR MIGRATION DATA — and beneath, in pencil: 'too late to restrict.'","A single line drawn in red ink under the phrase 'the Weave is not eternal.' Nothing else."],
  "Heartwood":    ["Pressed between pages 12 and 13: a leaf from no identified species, still faintly green.","Margin note: 'The tree is not dead. Dead is the wrong word. Ask me what the right word is if you can find me.'","Back cover: 'Do not bring this volume into the stump cavity. I mean this as practical advice.'","Stamp: RETURNED INCOMPLETE — below, different hand: 'the missing pages were somewhere else. I put them back where I found them.'"],
  "Life Stones":  ["Margin: 'The seventh stone is not missing. Someone has it.'","Pasted note: 'The recharge data in Table 4 has been altered from the Vault copy. Compare before drawing conclusions.'","Inside cover, faded: 'Etherium is not from any of the worlds the Andorians visited. I checked. I stopped checking because I did not want to find the answer.'","Stamp: LOAN RECORD SEALED — and beneath, scratched small: 'by order of someone who knew what was in here.'"],
  "Andorians":    ["Margin: 'The eighth training room is real. I found it. I am not writing the location here.'","Penciled: 'They built everything. They left. What we inherited was not designed to run without them.'","Inside cover: 'The uncorrupted ones who survived were changed by what they saw. The records do not capture it because the records were written by people who were not there.'","Stamp: CROSS-REFERENCE RESTRICTED — below, in pencil: 'specifically the cross-reference to the Mavashik intake records.'"],
  "Mavashik":     ["Margin: 'The void frost is spreading. Slowly. I have been measuring it for three years.'","Pasted note, edges burned: 'The seal was designed by the Andorians. The Andorians are gone.'","Scratched into the back cover: 'It knew my name before I told it. I found this account in the archive. It knew my name too.'","Stamp: KYROS MATERIALS — HANDLE UNDER PROTOCOL 7 — below: 'Protocol 7 has been suspended pending review. The review has been pending for forty years.'"],
  "Silver Flame": ["Margin: 'The Warforged who was present at the final battle is still active. They do not want to be found. Please respect this.'","Pasted slip: 'The last words of three champions cannot be translated. I have tried six languages. The words are not in any of them.'","Stamp: NOT FOR USE IN COALITION MEDIATION — below: 'there is no coalition left to mediate.'","Inside cover, two hands: First: 'The flame still burns somewhere.' Second: 'How do you know.' First: 'Because it would feel different if it did not.'"],
  "Any":          ["Margin, unknown hand: 'I was here before this tome. I will be here after it. The archive knows I am here. We have an arrangement.'","Pasted slip: 'The author of this document is not the person named on the spine. The person named on the spine died six years before the composition date.'","Stamp: CROSS-REFERENCE FLAGGED — below, three lines thoroughly blacked out.","Inside cover: 'I have read this four times. It says something different each time. On the fourth reading it said something addressed directly to me, by name.'"]
};

var truthTypes = ["Key","Lie","Bait","Prophecy","Trap","Map-Fragment","Cipher","Confession","Warning","Decoy","Partial Truth","Corrupted Record"];
var factions = [
  "a Sylvanox cell operating within the archive under false research credentials",
  "an agent of an unidentified party who has accessed this tome before the party",
  "the Archivist's Council itself, acting on information it has not made public",
  "a Warforged of uncertain allegiance whose movements through the archive have been noted",
  "a Silver Flame remnant pursuing an objective that predates the current political situation",
  "a Librarium Modron whose behavior has deviated from standard parameters",
  "whoever removed the sections missing from this tome — they had a reason",
  "a scholar whose research license was revoked eighteen months ago"
];
var hookPhrases = [
  "cross-references a volume that does not appear in the master index but physically exists in",
  "directly contradicts the canonical account held in the sealed section of",
  "names a specific location that does not appear on any map currently held in",
  "contains a cipher whose key exists only in the classified supplement to",
  "implies a secondary source deliberately omitted from the catalogue of",
  "points toward an access point in the archive not on the official map of"
];
var cNeutral = [
  {text:"No immediate consequence. The tome appears to be exactly what it claims to be.",a:0,c:0},
  {text:"A useful truth is obtained, but cross-referencing reveals a deliberate inconsistency with another source.",a:0,c:0},
  {text:"A false lead has been embedded convincingly. It holds unless the party consults a corroborating source.",a:0,c:0},
  {text:"The catalog entry for this tome has been quietly altered since last index. Someone knew to look here.",a:1,c:0},
  {text:"The tome is genuine but a key section has been excised recently and cleanly.",a:0,c:0}
];
var cAlive = [
  {text:"Attention +1. The stacks re-index around the reader. Something within the archive has registered this inquiry.",a:1,c:0},
  {text:"Contamination +1. A recurring element begins appearing in dreams — a glyph, a door, a phrase in an unfamiliar language.",a:0,c:1},
  {text:"Attention +1. A named NPC becomes aware of the party's research within the week.",a:1,c:0},
  {text:"Attention +1, Contamination +1. The tome reshelves itself before the session ends. No one witnesses it.",a:1,c:1},
  {text:"Contamination +1. The reader retains one phrase they cannot stop repeating internally.",a:0,c:1},
  {text:"Attention +2. A Librarium Modron arrives with polite questions. It already knows more than it should.",a:2,c:0},
  {text:"No clock change — this time. The consequence is deferred, not cancelled.",a:0,c:0},
  {text:"Contamination +2. A false memory is installed: the reader is certain they have encountered this knowledge before.",a:0,c:2},
  {text:"Attention +1. The borrowing record now lists the reader's name in a hand that is not the archivist's.",a:1,c:0},
  {text:"Contamination +1, Attention +1. The reader understands a passage that was previously illegible.",a:1,c:1}
];
var cHigh = [
  {text:"Attention +2, Contamination +1. The final page contains the reader's name. The ink is old. It was there before they arrived.",a:2,c:1},
  {text:"Contamination +3. The text shifts between readings. The third reading addresses the reader directly.",a:0,c:3},
  {text:"Attention +3. The Black Index has flagged this access. An investigator has already been assigned.",a:3,c:0}
];

function rnd(arr){return arr[Math.floor(Math.random()*arr.length)];}
function roll(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2);}
function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}

function shelf(wing,depth){
  var w=wing.slice(0,2).toUpperCase();
  var d=depth==="Hall"?"H":depth==="Vault"?"V":"B";
  return w+"-"+d+"-"+roll(1,9)+roll(0,9)+"."+roll(1,7)+"."+roll(1,12);
}

function makeTitle(tag){
  var cores=titleCore[tag]||titleCore["Any"];
  return rnd(titlePrefix)+" "+rnd(cores);
}

function pickAuthor(wing){
  if(wing==="Forbidden") return rnd(uldarNames);
  if(wing==="Planar") return rnd(Math.random()>0.5?andorianNames:modronNames);
  if(wing==="Liturgies") return rnd(andorianNames);
  return rnd(Math.random()>0.3?humanNames:andorianNames);
}

function getMarginalia(tag){
  var pool=marginalia[tag]||marginalia["Any"];
  return rnd(pool);
}

function go(){
  var wing=document.getElementById("wing").value;
  var depth=document.getElementById("depth").value;
  var topic=document.getElementById("topic").value;
  var risk=Number(document.getElementById("risk").value);
  var tag=topic==="Any"?rnd(["Eldraxis","Weave Theory","Heartwood","Life Stones","Andorians","Mavashik","Silver Flame"]):topic;
  var cpool=mode==="alive"?cAlive:cNeutral;
  if(risk>=4&&mode==="alive"){cpool=cpool.concat(cHigh);}
  var consequence=rnd(cpool);
  var dm={
    type:rnd(truthTypes),
    faction:rnd(factions),
    hook:"This tome "+rnd(hookPhrases)+" the "+depth+" of the "+wing+" Wing.",
    note:risk>=3?"Contradicts an established canonical position — may represent deliberate censorship, a planted lure, or evidence that the public and true records have diverged.":"Consistent with the standard account on the surface, but notably incomplete in ways that may be intentional.",
    consequence:consequence
  };
  currentTome={
    id:uid(),
    at:new Date().toISOString(),
    wing:wing,depth:depth,topic:topic,risk:risk,
    title:makeTitle(tag),
    author:pickAuthor(wing),
    era:rnd(eras),
    phys:rnd(physList),
    shelf:shelf(wing,depth),
    marginalia:getMarginalia(tag),
    dm:dm,
    tag:tag,
    style:style,
    deeperText:null
  };
  document.getElementById("btnSaveKey").addEventListener("click",function(){ var k=document.getElementById("apiKeyInput").value.trim(); if(k){ API_KEY=k; localStorage.setItem("myrraurel_api_key",k); document.getElementById("keyStatus").textContent="Saved."; document.getElementById("apiKeyInput").value=""; } else { document.getElementById("keyStatus").textContent="Enter a key first."; } }); if(API_KEY){ document.getElementById("keyStatus").textContent="Key loaded."; } paintTome();
  document.getElementById("btnSave").disabled=false;
  document.getElementById("btnReroll").disabled=false;
  if(consequence.a||consequence.c){
    clocks.attention=Math.min(6,clocks.attention+consequence.a);
    clocks.contamination=Math.min(6,clocks.contamination+consequence.c);
    localStorage.setItem(CK,JSON.stringify(clocks));
    paintClocks();
  }
}

function paintTome(){
  var t=currentTome;
  if(!t){
    document.getElementById("tomeOutput").innerHTML='<div class="empty-state"><div class="empty-glyph">&#x2B21;</div><p>Retrieve a tome to reveal its contents.</p><p class="hint">No one has ever reached its true depths. Some knowledge within was never meant to be found.</p></div>';
    return;
  }
  var rc=t.risk>=4?"rh":"";
  var dc=t.depth==="Black Index"?"db":"";
  var deeperHtml="";
  if(t.deeperText){
    var paras=t.deeperText.split(/\n\n+/).filter(function(p){return p.trim();});
    deeperHtml='<div class="deeper-label">Deeper Reading</div><div class="deeper-block">'+paras.map(function(p){return "<p>"+esc(p.trim())+"</p>";}).join("")+'</div>';
  }
  document.getElementById("tomeOutput").innerHTML=
    '<div class="card-title">'+esc(t.title)+'</div>'+
    '<div class="badges">'+
      '<span class="badge">'+esc(t.wing)+'</span>'+
      '<span class="badge '+dc+'">'+esc(t.depth)+'</span>'+
      '<span class="badge '+rc+'">Risk '+t.risk+'</span>'+
      '<span class="badge">'+esc(t.shelf)+'</span>'+
      '<span class="badge">'+esc(t.tag)+'</span>'+
    '</div>'+
    '<div class="slabel">Catalog Card</div>'+
    '<div class="card-meta">'+
      '<p><b>Author:</b> '+esc(t.author)+'&nbsp;&middot;&nbsp;<b>Era:</b> '+esc(t.era)+'</p>'+
      '<p><b>Condition:</b> '+esc(t.phys)+'</p>'+
    '</div>'+
    '<div class="marginalia"><b>Marginalia:</b> '+esc(t.marginalia)+'</div>'+
    deeperHtml+
    '<button class="btn btn-deeper" id="btnDeeper">'+(t.deeperText?'&#10022; Read Again Deeper':'&#10022; Read Deeper')+'</button>'+
    '<div class="slabel">DM Payload</div>'+
    '<details><summary>Reveal DM Payload</summary><div class="dm-inner">'+
      '<div class="dm-row"><span class="dm-key">True Nature</span><span>'+esc(t.dm.type)+'</span></div>'+
      '<div class="dm-row"><span class="dm-key">Faction</span><span>'+esc(t.dm.faction)+'</span></div>'+
      '<div class="dm-row"><span class="dm-key">Hook</span><span>'+esc(t.dm.hook)+'</span></div>'+
      '<div class="dm-row"><span class="dm-key">Continuity Note</span><span>'+esc(t.dm.note)+'</span></div>'+
      '<div class="dm-row"><span class="dm-key">Consequence</span><span>'+esc(t.dm.consequence.text)+'</span></div>'+
    '</div></details>';
  document.getElementById("btnDeeper").addEventListener("click", readDeeper);
}

function readDeeper(){
  var t=currentTome;
  if(!t) return;
  var btn=document.getElementById("btnDeeper");
  btn.disabled=true;
  btn.textContent="Consulting the Archive...";
  var styleDesc={
    academic:"scholarly and formal, written by a scholar of great learning recording knowledge for posterity",
    ominous:"dark and weighted, written by someone who understands the full implications of what they are describing and finds no comfort in that understanding",
    fragmented:"fragmented and damaged, written in incomplete passages with gaps, missing sections, and marginal notes from different hands — use [damaged] or [illegible] sparingly to indicate loss",
    firsthand:"personal and direct, written by someone who was present, who saw what they are describing, and who is writing this account privately, not for the official record"
  };
  var prompt="Write a tome excerpt found in the Myrr'aurel on the topic of "+t.tag+", retrieved from the "+t.depth+" of the "+t.wing+" Wing. The tome's title is '"+t.title+"'. Its author is "+t.author+", writing in the "+t.era+" period. The risk level of this tome is "+t.risk+" out of 5"+(t.risk>=4?" — this is a high-risk document containing dangerous or deeply classified knowledge":t.risk>=2?" — this document contains knowledge that is restricted or sensitive":"")+". The writing style should be "+styleDesc[t.style]+". Write 3 to 4 substantial paragraphs of the kind of content one might actually find in such a tome — not a description of the tome, but the actual text of the tome itself, as though the reader is reading the pages directly.";
  fetch("https://api.anthropic.com/v1/messages",{
    method:"POST",
    headers:{"Content-Type":"application/json","x-api-key":API_KEY,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
    body:JSON.stringify({
      model:"claude-sonnet-4-20250514",
      max_tokens:1000,
      system:WORLD_BRIEFING,
      messages:[{role:"user",content:prompt}]
    })
  }).then(function(r){return r.json();}).then(function(data){
    var text="";
    if(data.content&&data.content[0]&&data.content[0].text){
      text=data.content[0].text;
    } else if(data.error){
      text="[The archive does not respond. "+data.error.message+"]";
    }
    currentTome.deeperText=text;
    document.getElementById("btnSaveKey").addEventListener("click",function(){ var k=document.getElementById("apiKeyInput").value.trim(); if(k){ API_KEY=k; localStorage.setItem("myrraurel_api_key",k); document.getElementById("keyStatus").textContent="Saved."; document.getElementById("apiKeyInput").value=""; } else { document.getElementById("keyStatus").textContent="Enter a key first."; } }); if(API_KEY){ document.getElementById("keyStatus").textContent="Key loaded."; } paintTome();
  }).catch(function(err){
    currentTome.deeperText="[The deeper stacks are inaccessible. The Modrons have not returned from that corridor.]";
    document.getElementById("btnSaveKey").addEventListener("click",function(){ var k=document.getElementById("apiKeyInput").value.trim(); if(k){ API_KEY=k; localStorage.setItem("myrraurel_api_key",k); document.getElementById("keyStatus").textContent="Saved."; document.getElementById("apiKeyInput").value=""; } else { document.getElementById("keyStatus").textContent="Enter a key first."; } }); if(API_KEY){ document.getElementById("keyStatus").textContent="Key loaded."; } paintTome();
  });
}

function paintLedger(){
  var q=(document.getElementById("search").value||"").toLowerCase();
  var list=ledger.filter(function(t){return (t.title+" "+t.author+" "+t.wing+" "+t.tag).toLowerCase().indexOf(q)!==-1;});
  var el=document.getElementById("ledger");
  if(!list.length){el.innerHTML='<div class="ledger-empty">'+(ledger.length===0?"No tomes saved yet.":"No results.")+'</div>';return;}
  el.innerHTML=list.map(function(t,i){
    var deeperHtml="";
    if(t.deeperText){
      var paras=t.deeperText.split(/\n\n+/).filter(function(p){return p.trim();});
      deeperHtml='<div style="margin-top:8px;font-size:.8rem;color:#8a6fba;font-family:Cinzel,serif;letter-spacing:1px;text-transform:uppercase;">Deeper Reading</div><div class="li-excerpt" style="color:#d4cce8">'+paras.map(function(p){return "<p>"+esc(p.trim())+"</p>";}).join("")+'</div>';
    }
    return '<div class="li" onclick="toggleLedgerItem('+i+')">'+
      '<div class="li-title">'+esc(t.title)+'</div>'+
      '<div class="li-meta">'+esc(t.wing)+' &middot; '+esc(t.depth)+' &middot; Risk '+t.risk+' &middot; '+esc(t.shelf)+'</div>'+
      '<div class="li-meta">'+esc(t.author)+' &middot; '+esc(t.era)+'</div>'+
      '<div class="li-expanded" id="li-exp-'+i+'">'+
        '<div class="marginalia" style="margin-bottom:8px"><b>Marginalia:</b> '+esc(t.marginalia)+'</div>'+
        deeperHtml+
        '<details style="margin-top:8px"><summary>DM Payload</summary><div class="dm-inner">'+
          '<div class="dm-row"><span class="dm-key">True Nature</span><span>'+esc(t.dm.type)+'</span></div>'+
          '<div class="dm-row"><span class="dm-key">Faction</span><span>'+esc(t.dm.faction)+'</span></div>'+
          '<div class="dm-row"><span class="dm-key">Hook</span><span>'+esc(t.dm.hook)+'</span></div>'+
          '<div class="dm-row"><span class="dm-key">Consequence</span><span>'+esc(t.dm.consequence.text)+'</span></div>'+
        '</div></details>'+
      '</div>'+
    '</div>';
  }).join("");
}

function toggleLedgerItem(i){
  var el=document.getElementById("li-exp-"+i);
  if(el) el.classList.toggle("open");
}

function paintClocks(){
  paintPips("attentionPips",clocks.attention,"fa");
  paintPips("contaminationPips",clocks.contamination,"fc");
}

function paintPips(id,val,cls){
  var el=document.getElementById(id);
  if(!el) return;
  el.innerHTML="";
  for(var i=0;i<6;i++){
    var d=document.createElement("div");
    d.className="pip"+(i<val?" "+cls:"");
    el.appendChild(d);
  }
}

function setMode(m){
  mode=m;
  document.getElementById("modeNeutral").className="tbtn"+(m==="neutral"?" active":"");
  document.getElementById("modeAlive").className="tbtn"+(m==="alive"?" active":"");
  document.getElementById("modeDesc").textContent=m==="alive"?"Every pull can increment Attention & Contamination clocks.":"Danger only in Forbidden wing & Black Index.";
}

function setStyle(s){
  style=s;
  var ids=["styleAcademic","styleOminous","styleFragmented","styleFirsthand"];
  var styles=["academic","ominous","fragmented","firsthand"];
  for(var i=0;i<ids.length;i++){
    document.getElementById(ids[i]).className="sbtn"+(styles[i]===s?" active":"");
  }
}

document.getElementById("risk").addEventListener("input",function(){document.getElementById("riskVal").textContent=this.value;});
document.getElementById("btnPull").addEventListener("click",go);
document.getElementById("btnReroll").addEventListener("click",go);
document.getElementById("btnSave").addEventListener("click",function(){
  if(!currentTome) return;
  ledger.unshift(currentTome);
  localStorage.setItem(SK,JSON.stringify(ledger));
  paintLedger();
  var btn=document.getElementById("btnSave");
  btn.textContent="Saved!";
  setTimeout(function(){btn.textContent="Save to Ledger";},1500);
});
document.getElementById("btnExport").addEventListener("click",function(){
  var b=new Blob([JSON.stringify(ledger,null,2)],{type:"application/json"});
  var u=URL.createObjectURL(b);
  var a=document.createElement("a");
  a.href=u;a.download="myrraurel_ledger.json";a.click();
  URL.revokeObjectURL(u);
});
document.getElementById("btnClear").addEventListener("click",function(){
  if(!confirm("Clear ledger?")) return;
  ledger=[];localStorage.setItem(SK,JSON.stringify(ledger));paintLedger();
});
document.getElementById("btnResetClocks").addEventListener("click",function(){
  if(!confirm("Reset clocks?")) return;
  clocks={attention:0,contamination:0};localStorage.setItem(CK,JSON.stringify(clocks));paintClocks();
});
document.getElementById("importFile").addEventListener("change",function(e){
  if(!e.target.files||!e.target.files[0]) return;
  var r=new FileReader();
  r.onload=function(){
    try{var d=JSON.parse(r.result);if(!Array.isArray(d))throw new Error("bad");ledger=d;localStorage.setItem(SK,JSON.stringify(ledger));paintLedger();}
    catch(err){alert("Import failed: "+err.message);}
  };
  r.readAsText(e.target.files[0]);
});
document.getElementById("search").addEventListener("input",paintLedger);
document.getElementById("modeNeutral").addEventListener("click",function(){setMode("neutral");});
document.getElementById("modeAlive").addEventListener("click",function(){setMode("alive");});
document.getElementById("styleAcademic").addEventListener("click",function(){setStyle("academic");});
document.getElementById("styleOminous").addEventListener("click",function(){setStyle("ominous");});
document.getElementById("styleFragmented").addEventListener("click",function(){setStyle("fragmented");});
document.getElementById("styleFirsthand").addEventListener("click",function(){setStyle("firsthand");});

document.getElementById("btnSaveKey").addEventListener("click",function(){ var k=document.getElementById("apiKeyInput").value.trim(); if(k){ API_KEY=k; localStorage.setItem("myrraurel_api_key",k); document.getElementById("keyStatus").textContent="Saved."; document.getElementById("apiKeyInput").value=""; } else { document.getElementById("keyStatus").textContent="Enter a key first."; } }); if(API_KEY){ document.getElementById("keyStatus").textContent="Key loaded."; } paintTome();
paintLedger();
paintClocks();
</script>

</body>
</html>